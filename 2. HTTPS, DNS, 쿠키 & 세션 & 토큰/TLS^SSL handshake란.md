# TLS/SSL handshake란?

HTTPS에서 클라이언트와 서버간 통신 전 SSL 인증서로 **신뢰성 여부를 판단**하기 위해 연결하는 방식입니다.

암호화 통신은 일반적으로 TLS/SSL 프로토콜을 사용하여 이루어지는데, TLS/SSL 암호화 과정에서 필요한 정보(사용할 암호화 알고리즘, 키)의 교환을 위한 TLS Handshake 과정이 존재합니다. 해당 과정을 통하여 **세션을 생성**할 수 있고 이 후 두 노드의 통신은 세션 상에서 수행됩니다. SSL/TLS handshake를 사용하면 SSL 또는 TLS 클라이언트 및 서버가 통신하는 보안 키를 설정할 수 있습니다.

진행 순서는 다음과 같습니다.

1. 클라이언트는 서버에게 `client hello` 메시지를 담아 서버로 보낸다.
    
    이 때 암호화된 정보를 함께 담는데, `버전`, `암호 알고리즘`, `압축 방식` 등을 담는다.
    

2. 서버는 클라이언트가 보낸 암호 알고리즘과 압축 방식을 받고, `세션 ID`와 `CA 공개 인증서`를 `server hello` 메시지와 함께 담아 응답한다. 이 CA 인증서에는 앞으로 통신 이후 사용할 대칭키가 생성되기 전, 클라이언트에서 handshake 과정 속 암호화에 사용할 공개키를 담고 있다.

3. 클라이언트 측은 서버에서 보낸 CA 인증서에 대해 유효한지 CA 목록에서 확인하는 과정을 진행한다.

4. CA 인증서에 대한 신뢰성이 확보되었다면, 클라이언트는 의사 난수(pseudo-random) 바이트를 생성하여 서버의 공개키로 암호화한다. 이 난수 바이트는 대칭키를 정하는데 사용이 되고, 앞으로 서로 메시지를 통신할 때 암호화하는 데 사용된다.

5. 만약 2번 단계에서 서버가 `클라이언트 인증서` 를 함께 요구했다면, 클라이언트의 디지털 인증서 또는 `디지털 인증서 없음 경고` 와 클라이언트의 개인키로 암호화된 임의의 바이트 문자열을 함께 보내준다.

6. 서버는 클라이언트의 인증서를 확인 후, 난수 바이트를 자신의 개인키로 복호화 후 대칭 마스터 키 생성에 활용한다.

7. 클라이언트는 handshake 과정이 완료되었다는 `finished` 메시지를 서버에 보내면서, 지금까지 보낸 교환 내역들을 해싱 후 그 값을 대칭키로 암호화하여 같이 담아 보내준다.

8. 서버도 동일하게 교환 내용들을 해싱한 뒤 클라이언트에서 보내준 값과 일치하는지 확인한다. 일치하면 서버도 마찬가지로 `finished` 메시지를 만든 대칭키로 암호화하여 보낸다.

9. 클라이언트는 해당 메시지를 대칭키로 복호화하여 서로 통신이 가능한 신뢰받은 사용자란 걸 인지하고, 앞으로 클라이언트와 서버는 해당 대칭키로 데이터를 주고받을 수 있게 된다.